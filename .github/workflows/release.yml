name: Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: Released version
        type: string
        required: true


jobs:
  show-context:
    runs-on: ubuntu-latest
    steps:
      - name: Show github context object
        run: echo $JSON
        env:
          JSON: ${{ toJSON(github) }}
  
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Configure git
        run: |
          git config --global user.name "kota65535"
          git config --global user.email "kota65535@gmail.com"
      - name: Run npm version
        run: |
          set -x
          npm version ${{ inputs.version }}
      - name: Update the major version tag
        run: |
          set -x
          echo "MAJOR_VERSION=$(perl -ne 'print $1 if /^(.*?)\.(.*?)\.(.*?)$/' <<< '${{ github.event.inputs.version }}')"
          git tag -f v${MAJOR_VERSION}
      - name: Push them
        run: |
          set -x
          git pull --rebase
          git push origin HEAD
          git push --tags
